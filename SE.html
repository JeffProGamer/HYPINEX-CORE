<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HYPINEX — CodeX AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Monaco -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<style>
:root{
  --bg:#050505;--panel:#0d0d0d;--border:#2a2a2a;
  --text:#e6e6e6;--accent:#3a3a3a;--warn:#ff5555
}
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;background:var(--bg);color:var(--text);
  height:100vh;display:flex;flex-direction:column
}
header{
  padding:12px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px
}
select,input,button,textarea{
  background:#111;border:1px solid var(--border);
  color:var(--text);border-radius:10px;padding:8px
}
main{flex:1;display:flex;gap:10px;padding:10px}
#left{width:340px;display:flex;flex-direction:column;gap:8px}
#tree{flex:1;overflow:auto;font-size:12px;border:1px solid var(--border);border-radius:10px;padding:6px}
.node{cursor:pointer;padding:4px;border-left:2px solid #444;margin-left:6px}
.node:hover{background:#111}
#right{flex:1;display:flex;flex-direction:column;border:1px solid var(--border);border-radius:14px;background:var(--panel)}
#editor{flex:1}
#chat{flex:1;padding:10px;overflow:auto;white-space:pre-wrap}
.badge{font-size:11px;color:#aaa}
.warn{color:var(--warn);font-size:12px}
.hidden{display:none}
footer{display:flex;gap:6px;padding:8px;border-top:1px solid var(--border)}
</style>
</head>

<body>

<header>
  <b>HYPINEX — CodeX</b>

  <select id="model">
    <option value="fast">Fast</option>
    <option value="smart">Smart</option>
    <option value="codex">CodeX</option>
    <option value="image">Image</option>
  </select>

  <span class="badge" id="quota">quota: —</span>

  <input id="token" placeholder="Auth token (optional)">
</header>

<main>
  <!-- LEFT -->
  <div id="left">
    <textarea id="prompt" placeholder="Ask anything or paste code…"></textarea>

    <input type="file" id="files" multiple>

    <div id="moderation" class="warn hidden"></div>

    <button onclick="send()">Send</button>

    <div id="tree"><b>Conversation Tree</b></div>
  </div>

  <!-- RIGHT -->
  <div id="right">
    <div id="chat"></div>
    <div id="editor"></div>
  </div>
</main>

<footer>
  <button onclick="cancel()">Cancel</button>
  <button onclick="clearChat()">Clear</button>
</footer>

<script>
/* ================= STATE ================= */
let controller=null;
let parent=null;
let db;

/* ================= INDEXED DB ================= */
const openDB=indexedDB.open("hypinex",1);
openDB.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("tree",{keyPath:"id"});
};
openDB.onsuccess=e=>{db=e.target.result;loadTree()};

function saveNode(n){
  const tx=db.transaction("tree","readwrite");
  tx.objectStore("tree").put(n);
}
function loadTree(){
  const tx=db.transaction("tree","readonly");
  tx.objectStore("tree").getAll().onsuccess=e=>{
    renderTree(e.target.result)
  }
}

/* ================= TREE ================= */
function renderTree(nodes){
  const t=document.getElementById("tree");
  t.innerHTML="<b>Conversation Tree</b>";
  nodes.forEach(n=>{
    const d=document.createElement("div");
    d.className="node";
    d.textContent=n.prompt.slice(0,40);
    d.onclick=()=>parent=n.id;
    t.appendChild(d);
  });
}

/* ================= MONACO ================= */
let editor;
require.config({ paths:{ vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs" }});
require(["vs/editor/editor.main"],()=>{
  editor=monaco.editor.create(document.getElementById("editor"),{
    value:"",
    language:"plaintext",
    theme:"vs-dark",
    automaticLayout:true
  });
});

/* ================= SEND ================= */
async function send(){
  if(controller) controller.abort();
  controller=new AbortController();

  const prompt=document.getElementById("prompt").value.trim();
  if(!prompt) return;

  const node={id:crypto.randomUUID(),parent,prompt};
  saveNode(node); parent=node.id;

  const model=document.getElementById("model").value;
  const files=[...document.getElementById("files").files];

  const payload={prompt,parent,model,files:[]};

  for(const f of files){
    const buf=await f.arrayBuffer();
    payload.files.push({
      name:f.name,type:f.type,
      data:btoa(String.fromCharCode(...new Uint8Array(buf)))
    });
  }

  document.getElementById("chat").textContent="";
  editor.setValue("");

  const res=await fetch("/api/ai/stream",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":document.getElementById("token").value||""
    },
    body:JSON.stringify(payload),
    signal:controller.signal
  });

  if(!res.ok) return;

  const reader=res.body.getReader();
  const dec=new TextDecoder();

  while(true){
    const {value,done}=await reader.read();
    if(done) break;
    const chunk=dec.decode(value);

    const msg=JSON.parse(chunk);

    if(msg.blocked){
      const m=document.getElementById("moderation");
      m.textContent="Blocked: "+msg.reason;
      m.classList.remove("hidden");
      break;
    }

    if(msg.quota) document.getElementById("quota").textContent="quota: "+msg.quota;

    if(msg.type==="text"){
      document.getElementById("chat").textContent+=msg.data;
    }
    if(msg.type==="code"){
      editor.setValue(editor.getValue()+msg.data);
      monaco.editor.setModelLanguage(editor.getModel(),msg.language||"plaintext");
    }
    if(msg.type==="image"){
      const img=new Image();
      img.src=msg.data;
      document.getElementById("chat").appendChild(img);
    }
  }
}

/* ================= CONTROL ================= */
function cancel(){ if(controller) controller.abort() }
function clearChat(){
  document.getElementById("chat").textContent="";
  editor.setValue("");
}
</script>

</body>
</html>
